<style>
/*******************************
			General
*******************************/
body {
	min-width: 600px;
	overflow-x: hidden;
}

body a {
	text-decoration: none;
}
body a:hover {
	text-decoration: underline;
}
.collapsed {
	display: none;
}

/*******************************
			Operations / toolbar
*******************************/
#ops .toolbar a {
	margin-right: 8px;
}

#animeForm form .label {
	width: 80px;
	display: inline-block;
	text-align: right;
}
#animeForm form input {
	width: 270px;
}
#animeForm .buttons {
	height: 30px;
	width: 356px;
}
#animeForm .buttons * {
	float: right;
}
#animeForm .dupe .label, 
#animeForm .dupe button {
	visibility: hidden;
}

/*******************************
	Anime
*******************************/
.anime.loading {
	color: #ccc;
}
.anime {
	border-top: 1px dashed #000;
}
.anime .editAnime {
	color: #348017;
	margin-left: 8px;
}
.anime .removeAnime {
	color: #F75D59;
	margin-left: 16px;
}
.anime a.anidb {
	color: #000;
	font-weight: bold;
}
.anime .torrent {
	margin-left: 8px;
}

.anime .category.collapsed {
	display: block;
}
.anime .collapsed .torrent {
	display: none;
}
</style>

<script src="base.js"></script>
<script>
function parseAnime(item, exp) {
	var title = item.querySelector('title').firstChild.nodeValue,
		next = { 
			title: title,
			xml: item,
			ep: null
		},
		m = null;
	
	if (exp.prefs) {
		if (typeof(exp.prefs) !== 'string') {
			if (exp.prefs.length > 0) {
				for (var i = exp.prefs.length; i-- && !m; ) {
					m = new RegExp(exp.prefs[i]).exec(title);
				}
			}
		} else {
			m = new RegExp(exp.prefs).exec(title);
		}
	}
	
	if (m && m.length > 1) {
		next.ep = m[1];
	}
	
	return next;
};

function openLink(el) {
	var url = el.getAttribute('href');
	chrome.tabs.update(null, { url: url });
};

function collectEpisodes(anime, items, nextEpisodes, latest) {
	var maxLatest = 15,
		maxNext = 3;

	for (var i = 0; i < items.length && latest.length < maxLatest; i++) {
		var next = parseAnime(items[i], anime),
			obj = {
				name: next.title,
				url: items[i].querySelector('link').firstChild.nodeValue				
			};
		
		if (next.ep > anime.episode && nextEpisodes.length < maxNext) {
			nextEpisodes.push(obj);
		}
		
		latest.push(obj);
	}
};

function applyHref(d, el) {
	el.setAttribute('href', d.url);
};

function afterAnimeRendered(anime, el) {
	el.setAttribute('animeName', anime.name);
	
	var anidbUrl = 'http://anidb.net/perl-bin/animedb.pl?show=animelist&adb.search=' + escape(anime.name) + '&do.search=search';
	el.querySelector('.anidb').setAttribute('href', anidbUrl);
	
	el.className += ' loading';

	var req = new XMLHttpRequest();
	req.open('GET', 'http://www.nyaa.eu/?page=rss&cats=1_37&term=' + anime.name, true);
	req.onload = function() {		
		var next = [], latest = [];
			
		collectEpisodes(anime, req.responseXML.getElementsByTagName('item'), next, latest);
		
		UI.list(next, el, '.next .torrent', { render: applyHref });
		UI.list(latest, el, '.latest .torrent', { render: applyHref });
		
		UI.removeCls(el, 'loading');
	};
	req.send(null);
};

function addFilter(orig) {
	var d = UI.dupe(orig);
	d.querySelector('input').value = '';	
	d.className += ' dupe';
	
	return d;
};

function removeAnime(animeEl) {
	if (!confirm('u sure?'))
		return;

	var animes = getStoredAnimes(),
		name = animeEl.getAttribute('animeName'),
		idx = animes.indexOfByFn(function(a) {
			return a.name === name;
		});
	
	animes.splice(idx, 1);
	
	localStorage.setItem('animes', JSON.stringify(animes));
	
	animeEl.parentNode.removeChild(animeEl);
};

function increaseEpisode(animeEl) {
	var animes = getStoredAnimes(),
		name = animeEl.getAttribute('animeName'),
		idx = animes.indexOfByFn(function(a) {
			return a.name === name;
		});
	
	animes[idx].episode += 1;
	
	localStorage.setItem('animes', JSON.stringify(animes));
	
	window.location.reload();
};

function showAnimeForm(data) {
	var el = document.getElementById('animeForm');
	if (!data)
		data = {
			name: '',
			episode: '',
			prefs: ''
		};
	
	el.querySelector('[name="name"]').value = data.name;
	el.querySelector('[name="episode"]').value = data.episode;
	
	var addFilterBtn = el.querySelector('.addFilter');
	
	// TODO: optimize by re-using duped filters
	var dupedFilters = el.querySelectorAll('.dupe');
	for (var i = 0; i < dupedFilters.length; i++) {
		dupedFilters[i].parentNode.removeChild(dupedFilters[i]);
	}
	
	var filterField = el.querySelector('[name="prefs"]');
	if (typeof(data.prefs) === 'string') {
		filterField.value = data.prefs;
	} else {
		for (var i = 0; i < data.prefs.length; i++) {
			filterField.value = data.prefs[i];
			
			filterField = addFilter(filterField.parentNode).querySelector('[name="prefs"]');
		}
	}
	
	UI.showCard(el);
};

function editAnime(animeEl) {
	var form = document.getElementById('animeForm'),
		animes = getStoredAnimes(),
		name = animeEl.getAttribute('animeName'),
		idx = animes.indexOfByFn(function(o) {
			return o.name === name;
		});
		
	showAnimeForm(animes[idx]);
};

function saveAnime(form) {
	var v = UI.formValues(form.querySelector('form'));
	// TODO: validate v
	
	// some data changes/adjustments
	v.episode = parseInt(v.episode, 10);
	
	var animes = getStoredAnimes(),	
		idx = animes.indexOfByFn(function(o) {
			return o.name === v.name;
		});
	
	if (idx < 0)
		animes.push(v);
	else
		animes[idx] = v;
		
	animes.sort(function(a, b) {
		return a.name.toLowerCase() > b.name.toLowerCase();
	});
	
	localStorage.setItem('animes', JSON.stringify(animes));
};

function getStoredAnimes() {
	var a = localStorage.getItem('animes');
	if (a) {
		try {
			a = JSON.parse(a);
		} catch (e) {
			a = [];
		}
	}
		
	return a || [];
};

function exportJson() {
	var str = localStorage.getItem('animes'),
		impexp = document.getElementById('impexp');
	
	impexp.querySelector('textarea').value = str;
	
	UI.showCard(impexp);
};

function importJson() {
	if (confirm('u sure?')) {
		var impexp = document.getElementById('impexp'),
			str = impexp.querySelector('textarea').value;
			
		// TODO: check str!
		localStorage.setItem('animes', str);

		window.location.reload();
	}
};

window.onload = function() {
	var root = document.getElementById('animes'),
		animes = getStoredAnimes();
		
	UI.list(animes, root, '.anime', { render: afterAnimeRendered });
};
</script>

<body>
	<div id="ops">
		<div class="toolbar">
			<a href="javascript:void(0);" onclick="showAnimeForm();">add</a>
			<a href="javascript:void(0);" onclick="exportJson();">import / export</a>
		</div>
		
		<div id="animeForm" class="collapsed" cardScope="head">
			<form>
			<div>
				<span class="label">Name</span>
				<input type="text" name="name">
			</div>
			<div>
				<span class="label">Episode</span>
				<input type="text" name="episode">
			</div>
			<div>
				<span class="label">Preferred</span>
				<input type="text" name="prefs">
				<button class="addFilter" onclick="addFilter(this.parentNode); return false;">+</button>
			</div>
			<div class="buttons">
				<button onclick="saveAnime(document.getElementById('animeForm'));">Save</button>
			</div>
			</form>
		</div>
		
		<div id="impexp" class="collapsed" cardScope="head">
			<textarea></textarea>
			<button onclick="importJson();">Import</button>
		</div>
	</div>

	<div id="animes">
		<div class="anime" bindScope="anime">
			<div class="title">
				<a class="anidb" onclick="openLink(this);" bindField="name" bindScope="anime">Whatever</a>
				<a class="plusOne" href="javascript:void(0);" onclick="increaseEpisode(this.parentNode.parentNode);">+1</a>
				<a class="editAnime" href="javascript:void(0);" onclick="editAnime(this.parentNode.parentNode);">edit</a>
				<a class="removeAnime" href="javascript:void(0);" onclick="removeAnime(this.parentNode.parentNode);">delete</a>
			</div>
			<div class="downloads">
				<div class="category next">
					<span class="title">Next</span>
					<a class="torrent" onclick="openLink(this);" bindField="name">Loading...</a>
				</div>
				<div class="category latest collapsed">				
					<a class="title" href="javascript:void(0);" onclick="UI.toggleCls(this.parentNode, 'collapsed');">Latest</a>
					<a class="torrent" onclick="openLink(this);" bindField="name">Loading...</a>
				</div>
			</div>
		</div>
	</div>
</body>