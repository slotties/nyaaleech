<style>
body {
	min-width: 600px;
	overflow-x: hidden;
}

.anime.loading {
	color: #ccc;
}
.anime {
	border-bottom: 1px dashed #000;
	margin-bottom: 4px;
	margin-top: 4px;
}
.anime:last-child {
	border-bottom: none;
}

.title {
	font-weight: bold;
}
.latest .title {
	cursor: pointer;
}

.torrent {
	margin-left: 8px;
	text-decoration: none;
}

.torrent:hover {
	text-decoration: underline;
}

.collapsed .torrent {
	display: none;
}

#ops {
	border-bottom: 1px dashed #000;
}

#animeForm .label {
	width: 80px;
	display: inline-block;
	text-align: right;
}

#animeForm input {
	width: 270px;
}

#animeForm .buttons {
	height: 30px;
	width: 356px;
}
#animeForm .buttons * {
	float: right;
}

#animeForm .dupe .label, 
#animeForm .dupe button {
	visibility: hidden;
}

#animeForm.collapsed {
	display: none;
}
</style>
<script>
// TODO: add some simple management ui
var CONFIG = {
	maxNext: 3,
	maxLatest: 15
	
	/*animes: [
		{
			name: 'Bleach', lastEp: 355,
			prefs: /\[HorribleSubs\] Bleach - ([0-9]*)/
		},
		{
			name: 'Mirai Nikki', lastEp: 13,
			prefs: /\[GotWoot\]_Mirai_Nikki_([0-9]*)/
		},
		{
			name: 'Amagami SS Plus', lastEp: 2,
			prefs: /\[UTW\]_Amagami_SS_Plus_-_([0-9]*)/
		},
		{
			name: 'Ano Natsu de Matteru', lastEp: 1,
			prefs: /.*Ano Natsu de Matteru - ([0-9]*)/
		},
		{
			name: 'Another', lastEp: 1,
			prefs: /\[HorribleSubs\] Another - ([0-9]*)/
		},
		{
			name: 'Brave10', lastEp: 1,
			prefs: /\[Hiryuu\] Brave10 ([0-9]*)/
		},
		{
			name: 'Daily Lives of High School Boys', lastEp: 1,
			prefs: /\[sage\]_Daily_Lives_of_High_School_Boys_-_([0-9]*)/
		},
		{
			name: 'Kimi to Boku', lastEp: 12,
			prefs: [
				/\[CTSS\] Kimi to Boku - ([0-9]*)/,
				/\[sage\]_Kimi_to_Boku_-_([0-9]*)/
			]
		},
		{
			name: 'Nisemonogatari', lastEp: 1,
			prefs: /\[HorribleSubs\] Nisemonogatari - ([0-9]*) \[1080p\]/
		}
	]*/
};

/*
UI-Library
*/
var UI = {},
	UTIL = {};

// TODO: bindAttribute to bind attributes, bindText to bind text, bindHtml to bind innerhtml
UI.bindField = function(el, data) {
	var k = el.getAttribute('bindField'),
		v = data[k];
	
	// substitute render-functions
	// TODO: test
	/*if (typeof(v) === 'function')
		v = v(k, el, data);*/
	
	el.innerText = v;
};

UI.bindFields = function(protEl, data) {
	if (protEl.hasAttribute('bindScope')) {
		var binds = protEl.querySelectorAll('[bindScope=' + protEl.getAttribute('bindScope') + ']');
	} else {
		var binds = protEl.querySelectorAll('[bindField]');
	}
	
	if (protEl.hasAttribute('bindField'))
		UI.bindField(protEl, data);
		
	for (var i = 0; i < binds.length; i++) {
		UI.bindField(binds[i], data);
	}
};

UI.list = function(data, rootEl, itemPrototypeSelector, conf) {
	var p = rootEl.querySelector(itemPrototypeSelector),
		bindScope = p.getAttribute('bindScope');
		
	for (var i = 0; i < data.length; i++) {
		var c = p.cloneNode(true);
		
		UI.bindFields(c, data[i]);
		
		p.parentNode.appendChild(c);
		
		UTIL.signal(conf.render, [ data[i], c ]);
	}
	
	p.parentNode.removeChild(p);
};

UI.dupe = function(el) {
	var d = el.cloneNode(true);
	// TODO: remove all id's
	if (el.parentNode.lastChild === el)
		el.parentNode.appendChild(d);
	else
		el.parentNode.insertBefore(d, el.nextSibling);
		
	return d;
};

UI.formValues = function(form) {
	var values = {},
		e = form.elements;
		
	if (e.length > 0) {
		for (var i = e.length; i--; ) {
			var n = e[i].getAttribute('name'),
				v = e[i].value;
				
			if (typeof(n) === 'string') {
				if (typeof(values[n]) !== 'undefined') {
					if (typeof(values[n].push) === 'function')
						values[n].push(v);
					else
						values[n] = [ values[n], v ];
				} else {
					values[n] = v;
				}
			}
		}
	}
	
	return values;
};

UTIL.signal = function(listeners, args) {
	if (!listeners)
		return;

	if (typeof(listeners) === 'function')
		listeners.apply(window, args);
	else
		for (var i = 0; i < listeners.length; i++)
			listeners[i].apply(window, args);
};

Array.prototype.indexOfByFn = function(fn) {
	if (this.length > 0)
		for (var i = this.length; i--;) 
			if (fn(this[i]) === true)
				return i;
				
	return -1;
};

/*
Extension code
*/
function toggleExpand(el) {
	if (el.className.indexOf('collapsed') >= 0)
		el.className = el.className.replace(/collapsed/g, '');
	else
		el.className += 'collapsed';
};

function isNextEpisode(next, anime) {
	return (next.ep > anime.episode);
};

function parseAnime(item, exp) {
	var title = item.querySelector('title').firstChild.nodeValue,	
		next = {
			title: title,
			xml: item,
			ep: null
		},
		m = null;
	
	if (exp.prefs) {
		if (exp.prefs.length > 0) {
			// array
			for (var i = exp.prefs.length; i-- && !m; ) {
				m = new RegExp(exp.prefs[i]).exec(title);
			}
		} else {
			m = new RegExp(exp.prefs).exec(title);
		}
	}
	
	if (m && m.length > 1) {
		next.ep = m[1];
	}
	
	return next;
};

function downloadTorrent(el) {
	var url = el.getAttribute('href');
	chrome.tabs.update(null, { url: url });
};

function collectEpisodes(anime, items, nextEpisodes, latest) {
	for (var i = 0, ml = CONFIG.maxLatest; i < items.length && latest.length < ml; i++) {
		var next = parseAnime(items[i], anime),
			obj = {
				name: next.title,
				url: items[i].querySelector('link').firstChild.nodeValue				
			};
		
		if (isNextEpisode(next, anime) && nextEpisodes.length < CONFIG.maxNext) {
			nextEpisodes.push(obj);
		}
		
		latest.push(obj);
	}
};

function applyHref(d, el) {
	el.setAttribute('href', d.url);
};

function prepareRemoveBtn(anime, el) {
	el.querySelector('.removeAnime').setAttribute('animeName', anime.name);
};

function pullTorrents(anime, el) {
	el.className += ' loading';

	var req = new XMLHttpRequest();
	req.open('GET', 'http://www.nyaa.eu/?page=rss&cats=1_37&term=' + anime.name, true);
	req.onload = function() {		
		var next = [], latest = [];
			
		collectEpisodes(anime, req.responseXML.getElementsByTagName('item'), next, latest);
		
		UI.list(next, el, '.next .torrent', { render: applyHref });
		UI.list(latest, el, '.latest .torrent', { render: applyHref });
		
		el.className = el.className.replace(/loading/g, '');
	};
	req.send(null);
};

window.onload = function() {
	var root = document.getElementById('animes'),
		animes = getStoredAnimes();
	
	UI.list(animes, root, '.anime', { render: [ prepareRemoveBtn, pullTorrents ] });
};

function addFilter(orig) {
	var d = UI.dupe(orig);
	d.querySelector('input').value = '';	
	d.className += ' dupe';
};

function removeAnime(name) {
	var animes = getStoredAnimes(),
		idx = animes.indexOfByFn(function(a) {
		console.log(a.name + " # " + name);
		return a.name === name;
	});
	
	if (idx >= 0)
		animes.splice(idx, 1);
	
	localStorage.setItem('animes', JSON.stringify(animes));
	
	// TODO: remove from UI
};

function saveAnime(form) {
	var v = UI.formValues(form.querySelector('form'));
	// TODO: validate v
	
	// some data changes/adjustments
	v.episode = parseInt(v.episode, 10);
	
	var animes = getStoredAnimes(),	
		idx = animes.indexOfByFn(function(o) {
			return o.name === v.name;
		});
	
	if (idx < 0)
		animes.push(v);
	else
		animes[idx] = v;
		
	animes.sort(function(a, b) {
		return a.name.toLowerCase() > b.name.toLowerCase();
	});
		
	localStorage.setItem('animes', JSON.stringify(animes));
	
	// TODO: reload UI
};

function removeStoredAnimes() {
	if (confirm('u sure? really?'))
		localStorage.removeItem('animes');
};

function getStoredAnimes() {
	var a = localStorage.getItem('animes');
	if (a)
		a = JSON.parse(a);
	else
		a = [];
		
	return a;
};
</script>

<body>
	<div id="ops">
		<div class="toolbar">
			<a href="javascript:void(0);" onclick="toggleExpand(document.getElementById('animeForm'));">Add</a>
			<a href="javascript:void(0);" onclick="removeStoredAnimes();">Remove all animes</a>
		</div>
		<div id="animeForm" class="collapsed">
			<form>
			<div>
				<span class="label">Name:</span>
				<input type="text" name="name">
			</div>
			<div>
				<span class="label">Episode:</span>
				<input type="text" name="episode">
			</div>
			<div>
				<span class="label">Preferred:</span>
				<input type="text" name="prefs">
				<button onclick="addFilter(this.parentNode); return false;">+</button>
			</div>
			<div class="buttons">
				<button onclick="saveAnime(document.getElementById('animeForm'));">Save</button>
			</div>
			</form>
		</div>
	</div>

	<div id="animes">
		<div class="anime" bindScope="anime">
			<div class="title">
				<span bindField="name" bindScope="anime">Whatever</span>
				<button class="removeAnime" onclick="removeAnime(this.getAttribute('animeName'));">X</button>
			</div>
			<div class="downloads">
				<div class="category next">
					<span class="title">Next</span>
					<a class="torrent" onclick="downloadTorrent(this);" bindField="name">Loading...</a>
				</div>
				<div class="category latest collapsed">				
					<span class="title" onclick="toggleExpand(this.parentNode);">Latest</span>
					<a class="torrent" onclick="downloadTorrent(this);" bindField="name">Loading...</a>
				</div>
			</div>
		</div>
	</div>
</body>